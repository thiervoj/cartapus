!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e||self)["'Cartapus'"]=t()}(this,function(){function e(t,r){return e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},e(t,r)}function t(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,o=new Array(t);r<t;r++)o[r]=e[r];return o}function o(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(o)return(o=o.call(e)).next.bind(o);if(Array.isArray(e)||(o=function(e,t){if(e){if("string"==typeof e)return r(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var s=0;return function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function s(){}s.prototype={on:function(e,t,r){var o=this.e||(this.e={});return(o[e]||(o[e]=[])).push({fn:t,ctx:r}),this},once:function(e,t,r){var o=this;function s(){o.off(e,s),t.apply(r,arguments)}return s._=t,this.on(e,s,r)},emit:function(e){for(var t=[].slice.call(arguments,1),r=((this.e||(this.e={}))[e]||[]).slice(),o=0,s=r.length;o<s;o++)r[o].fn.apply(r[o].ctx,t);return this},off:function(e,t){var r=this.e||(this.e={}),o=r[e],s=[];if(o&&t)for(var n=0,a=o.length;n<a;n++)o[n].fn!==t&&o[n].fn._!==t&&s.push(o[n]);return s.length?r[e]=s:delete r[e],this}};var n=s;return n.TinyEmitter=s,/*#__PURE__*/function(r){var s,n;function a(e){var o;return void 0===e&&(e={}),(o=r.call(this)||this).intersect=o.intersect.bind(t(o)),o.mutate=o.mutate.bind(t(o)),o.options=Object.assign({root:null,rootMargin:"0px",threshold:0,once:!1},e),o.observers=[o.createObserver()],o.createObservers(),o.createMutationObserver(),o.observe(),o}n=r,(s=a).prototype=Object.create(n.prototype),s.prototype.constructor=s,e(s,n);var i=a.prototype;return i.createObservers=function(){for(var e,t=o((this.options.root?this.options.root:document).querySelectorAll("[data-cartapus]"));!(e=t()).done;)this.storeNewElement(e.value)},i.findObserverForElement=function(e){var t=e.dataset.cartapusThreshold?parseFloat(e.dataset.cartapusThreshold):this.options.threshold,r=e.dataset.cartapusRootMargin?e.dataset.cartapusRootMargin:this.options.rootMargin;return this.observers.find(function(e){return e.threshold===t&&e.rootMargin===r})},i.storeNewElement=function(e){if(!e.hasAttribute("data-cartapus"))return!1;if(e.dataset.cartapusThreshold||e.dataset.cartapusRootMargin){var t=this.findObserverForElement(e);if(t)t.elements.push(e),e._cartapus=t;else{var r=e.dataset.cartapusThreshold?parseFloat(e.dataset.cartapusThreshold):this.options.threshold;this.observers.push(this.createObserver({element:e,options:{threshold:r,rootMargin:e.dataset.cartapusRootMargin?e.dataset.cartapusRootMargin:this.options.rootMargin}}))}}else this.observers[0].elements.push(e),e._cartapus=this.observers[0];return!0},i.createObserver=function(e){var t=void 0===e?{}:e,r=t.element,o=Object.assign(this.options,t.options),s={observer:new IntersectionObserver(this.intersect,o),threshold:o.threshold,rootMargin:o.rootMargin,elements:r?[r]:[]};return r&&(r._cartapus=s),s},i.createMutationObserver=function(){this.mutationObserver=new MutationObserver(this.mutate),this.mutationObserver.observe(this.options.root?this.options.root:document.body,{childList:!0,subtree:!0})},i.intersect=function(e,t){for(var r,s=o(e);!(r=s()).done;){var n=r.value;n.isIntersecting?(n.target.setAttribute("data-cartapus","visible"),n.target.hasAttribute("data-cartapus-once")&&t.unobserve(n.target)):n.target.setAttribute("data-cartapus","hidden"),this.dispatch(n)}},i.dispatch=function(e){var t={element:e.target,visible:e.isIntersecting,intersection:e},r=new CustomEvent("cartapusintersect",{detail:t});e.target.dispatchEvent(r),this.emit("intersect",t)},i.mutate=function(e){for(var t,r=o(e);!(t=r()).done;){var s=t.value;if("childList"===s.type){for(var n,a=o(s.addedNodes);!(n=a()).done;){var i=n.value;this.storeNewElement(i)&&i._cartapus.observer.observe(i);for(var u,c=o(i.querySelectorAll("[data-cartapus]"));!(u=c()).done;){var l=u.value;this.storeNewElement(l)&&l._cartapus&&l._cartapus.observer.observe(l)}}for(var v,d=o(s.removedNodes);!(v=d()).done;){var h=v.value;if(h._cartapus){var p=h._cartapus.elements.indexOf(h);h._cartapus.elements.splice(p,1),h._cartapus.observer.unobserve(h)}for(var f,b=o(h.querySelectorAll("[data-cartapus]"));!(f=b()).done;){var m=f.value;if(m._cartapus){var g=m._cartapus.elements.indexOf(m);m._cartapus.elements.splice(g,1),m._cartapus.observer.unobserve(m)}}}}}},i.observe=function(){for(var e,t=o(this.observers);!(e=t()).done;)for(var r,s=e.value,n=o(s.elements);!(r=n()).done;)s.observer.observe(r.value)},i.unobserve=function(){for(var e,t=o(this.observers);!(e=t()).done;)for(var r,s=e.value,n=o(s.elements);!(r=n()).done;)s.observer.unobserve(r.value)},i.destroy=function(){this.unobserve(),this.mutationObserver.disconnect();for(var e,t=o(this.observers);!(e=t()).done;){for(var r,s=e.value,n=o(s.elements);!(r=n()).done;)delete r.value._cartapus;s.observer.disconnect(),s.elements=[]}},a}(n)});
