!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e||self)["'Cartapus'"]=t()}(this,function(){function e(t,r){return e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},e(t,r)}function t(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,s=new Array(t);r<t;r++)s[r]=e[r];return s}function s(e,t){var s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(s)return(s=s.call(e)).next.bind(s);if(Array.isArray(e)||(s=function(e,t){if(e){if("string"==typeof e)return r(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);return"Object"===s&&e.constructor&&(s=e.constructor.name),"Map"===s||"Set"===s?Array.from(e):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){s&&(e=s);var o=0;return function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(){}o.prototype={on:function(e,t,r){var s=this.e||(this.e={});return(s[e]||(s[e]=[])).push({fn:t,ctx:r}),this},once:function(e,t,r){var s=this;function o(){s.off(e,o),t.apply(r,arguments)}return o._=t,this.on(e,o,r)},emit:function(e){for(var t=[].slice.call(arguments,1),r=((this.e||(this.e={}))[e]||[]).slice(),s=0,o=r.length;s<o;s++)r[s].fn.apply(r[s].ctx,t);return this},off:function(e,t){var r=this.e||(this.e={}),s=r[e],o=[];if(s&&t)for(var a=0,n=s.length;a<n;a++)s[a].fn!==t&&s[a].fn._!==t&&o.push(s[a]);return o.length?r[e]=o:delete r[e],this}};var a=o;return a.TinyEmitter=o,/*#__PURE__*/function(r){var o,a;function n(e){var s;return void 0===e&&(e={}),(s=r.call(this)||this).intersect=s.intersect.bind(t(s)),s.mutate=s.mutate.bind(t(s)),s.isObserving=!1,s.options=Object.assign({root:null,rootMargin:"0px",threshold:0,once:!1},e),s.observers=[s.createObserver()],s.createObservers(),s.createMutationObserver(),s.observe(),s}a=r,(o=n).prototype=Object.create(a.prototype),o.prototype.constructor=o,e(o,a);var i=n.prototype;return i.createObservers=function(){for(var e,t=s((this.options.root?this.options.root:document).querySelectorAll("[data-cartapus]"));!(e=t()).done;)this.storeNewElement(e.value)},i.findObserverForElement=function(e){if(e){var t=e.dataset.cartapusThreshold?parseFloat(e.dataset.cartapusThreshold):this.options.threshold,r=e.dataset.cartapusRootMargin?e.dataset.cartapusRootMargin:this.options.rootMargin;return this.observers.find(function(e){return e.threshold===t&&e.rootMargin===r})}},i.storeNewElement=function(e){if(!e||!e.hasAttribute||!e.hasAttribute("data-cartapus"))return!1;if(e.dataset.cartapusThreshold||e.dataset.cartapusRootMargin){var t=this.findObserverForElement(e);if(t)t.elements.push(e),e._cartapus=t;else{var r=e.dataset.cartapusThreshold?parseFloat(e.dataset.cartapusThreshold):this.options.threshold;this.observers.push(this.createObserver({element:e,options:{threshold:r,rootMargin:e.dataset.cartapusRootMargin?e.dataset.cartapusRootMargin:this.options.rootMargin}}))}}else this.observers[0].elements.push(e),e._cartapus=this.observers[0];return!0},i.createObserver=function(e){var t=void 0===e?{}:e,r=t.element,s=Object.assign(this.options,t.options),o={observer:new IntersectionObserver(this.intersect,s),threshold:s.threshold,rootMargin:s.rootMargin,elements:r?[r]:[],once:!(!r||!r.hasAttribute("data-cartapus-once")||"false"===r.getAttribute("data-cartapus-once"))||s.once};return r&&(r._cartapus=o),o},i.createMutationObserver=function(){this.mutationObserver=new MutationObserver(this.mutate),this.mutationObserver.observe(this.options.root?this.options.root:document.body,{childList:!0,subtree:!0})},i.intersect=function(e,t){for(var r,o=s(e);!(r=o()).done;){var a=r.value;if(a.isIntersecting){a.target.setAttribute("data-cartapus","visible");var n=a.target.getAttribute("data-cartapus-once");if("false"===n)continue;(a.target._cartapus.once||null!==n)&&t.unobserve(a.target)}else a.target.setAttribute("data-cartapus","hidden");this.dispatch(a)}},i.dispatch=function(e){var t={element:e.target,visible:e.isIntersecting,intersection:e},r=new CustomEvent("cartapusintersect",{detail:t});e.target.dispatchEvent(r),this.emit("intersect",t)},i.mutate=function(e){for(var t,r=s(e);!(t=r()).done;){var o=t.value;if("childList"===o.type){for(var a,n=s(o.addedNodes);!(a=n()).done;){var i=a.value;if(this.storeNewElement(i)&&i._cartapus.observer.observe(i),i._cartapus)for(var u,c=s(i.querySelectorAll("[data-cartapus]"));!(u=c()).done;){var v=u.value;this.storeNewElement(v)&&v._cartapus&&v._cartapus.observer.observe(v)}}for(var l,d=s(o.removedNodes);!(l=d()).done;){var f=l.value;if(f._cartapus){var h=f._cartapus.elements.indexOf(f);f._cartapus.elements.splice(h,1),f._cartapus.observer.unobserve(f)}if(f._cartapus)for(var p,b=s(f.querySelectorAll("[data-cartapus]"));!(p=b()).done;){var m=p.value;if(m._cartapus){var g=m._cartapus.elements.indexOf(m);m._cartapus.elements.splice(g,1),m._cartapus.observer.unobserve(m)}}}}}},i.observe=function(){if(!this.isObserving){this.isObserving=!0;for(var e,t=s(this.observers);!(e=t()).done;)for(var r,o=e.value,a=s(o.elements);!(r=a()).done;)o.observer.observe(r.value)}},i.unobserve=function(){if(this.isObserving){this.isObserving=!1;for(var e,t=s(this.observers);!(e=t()).done;)for(var r,o=e.value,a=s(o.elements);!(r=a()).done;)o.observer.unobserve(r.value)}},i.triggerEvent=function(e){if(e)for(var t,r=s(Array.isArray(e)?e:[e]);!(t=r()).done;){var o=t.value;o._cartapus&&(o._cartapus.observer.unobserve(o),o._cartapus.observer.observe(o))}else for(var a,n=s(this.observers);!(a=n()).done;)for(var i,u=a.value,c=s(u.elements);!(i=c()).done;){var v=i.value;u.observer.unobserve(v),u.observer.observe(v)}},i.add=function(e){var t=this.storeNewElement(e);return t&&e._cartapus.observer.observe(e),t},i.destroy=function(){this.unobserve(),this.mutationObserver.disconnect();for(var e,t=s(this.observers);!(e=t()).done;){for(var r,o=e.value,a=s(o.elements);!(r=a()).done;)delete r.value._cartapus;o.observer.disconnect(),o.elements=[]}},n}(a)});
